# 市场 API

本文档提供 RWA 市场合约的 API 文档，该合约在首次发行阶段完成后启用 RWA 代币的二级交易。

## 概览

市场合约为 RWA 代币提供去中心化交易所，内置滑点保护和费用机制。它支持使用批准的稳定币买卖 RWA 代币。

---

## 合约接口

### Buy 函数

使用稳定币购买 RWA 代币。

```solidity
function buy(
    address token,      // 稳定币地址（如 WeUSD）
    uint256 tokenWorth, // 要花费的稳定币金额
    uint256 desired     // 预期最小 RWA 代币数量（滑点保护）
) external returns (
    uint256 amount,     // 实际收到的 RWA 代币数量
    uint256 fee         // 开发者费用（以 RWA 代币计）
)
```

**要求：**
- 市场必须活跃
- 合约不能暂停
- 代币必须在批准的购买列表中
- 必须授予足够的稳定币额度

**示例：**

```typescript
const market = new ethers.Contract(marketAddress, MARKET_ABI, signer);
const weusd = new ethers.Contract(weusdAddress, ERC20_ABI, signer);

// 1. 授权稳定币
const tokenWorth = ethers.parseUnits("100", 6); // 100 WeUSD
await weusd.approve(marketAddress, tokenWorth);

// 2. 计算预期输出（1% 滑点容忍度）
const expectedOutput = await market.calculateBuyOutput(tokenWorth);
const minOutput = expectedOutput * 99n / 100n; // 1% 滑点

// 3. 执行购买
const [amount, fee] = await market.buy(weusdAddress, tokenWorth, minOutput);
console.log(`收到: ${ethers.formatUnits(amount, 18)} RWA 代币`);
console.log(`费用: ${ethers.formatUnits(fee, 18)} RWA 代币`);
```

### Sell 函数

出售 RWA 代币换取稳定币。

```solidity
function sell(
    address token,    // 要接收的稳定币地址
    uint256 amount,   // 要出售的 RWA 代币数量
    uint256 desired   // 预期最小稳定币数量（滑点保护）
) external returns (
    uint256 worth,    // 实际收到的稳定币数量
    uint256 fee       // 开发者费用（以 RWA 代币计）
)
```

---

## 查询函数

### 获取当前价格

```typescript
const price = await market.getPrice();
console.log(`当前价格: ${ethers.formatUnits(price, 18)} USDC/RWA`);
```

### 获取地板价

地板价计算公式：`国库资产 / 流通供应量`

```typescript
const floorPrice = await market.getFloorPrice();
console.log(`地板价: ${ethers.formatUnits(floorPrice, 18)} USDC/RWA`);
```

### 获取国库余额

```typescript
const treasury = await market.getTreasuryBalance();
console.log(`国库: ${ethers.formatUnits(treasury, 6)} USDC`);
```

### 获取流通供应量

```typescript
const supply = await market.getCirculatingSupply();
console.log(`流通供应量: ${ethers.formatUnits(supply, 18)} RWA`);
```

### 计算购买输出

预览给定稳定币输入将收到的 RWA 代币数量。

```typescript
const input = ethers.parseUnits("1000", 6); // 1000 USDC
const output = await market.calculateBuyOutput(input);
console.log(`预期输出: ${ethers.formatUnits(output, 18)} RWA 代币`);
```

### 计算出售输出

预览出售 RWA 代币将收到的稳定币数量。

```typescript
const input = ethers.parseUnits("100", 18); // 100 RWA 代币
const output = await market.calculateSellOutput(input);
console.log(`预期输出: ${ethers.formatUnits(output, 6)} USDC`);
```

---

## 重要说明

### 代币精度

| 代币 | 精度 |
|-------|----------|
| WeUSD | 6 |
| USDC | 18 |
| RWA Token | 18 |

所有价格相关值使用 18 位精度（`1e18`）。

### 滑点保护

买卖函数中的 `desired` 参数提供滑点保护：
- 设置为可接受的最小输出金额
- 如果实际输出小于 `desired`，交易将回滚
- 建议：计算预期输出并应用 0.5-2% 的滑点容忍度

```typescript
// 示例：1% 滑点容忍度
const slippageBps = 100; // 1% = 100 基点
const minOutput = expectedOutput * (10000n - BigInt(slippageBps)) / 10000n;
```

### 费用结构

- 所有费用以基点表示（10000 = 100%）
- 费用从交易中以 RWA 代币扣除
- 费率由合约所有者配置

